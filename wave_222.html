<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wave 合併榜單（Clean 維護介面＋TopN 合併）</title>

  <!-- jQuery & DataTables & Buttons -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.0.2/css/buttons.dataTables.min.css" />
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.html5.min.js"></script>

  <style>
    :root{ --bg:#fafafa; --card:#fff; --border:#e5e7eb; --text:#111; --muted:#666; --primary:#3b82f6;
           --chip:#f3f4f6; --chip-border:#e5e7eb; --hover:#eef6ff; }
    *{box-sizing:border-box}
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:1240px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:grid;gap:12px}
    .row.two{grid-template-columns:1fr 2fr}
    .row.four{grid-template-columns:repeat(4,1fr)}
    label{font-size:13px;color:#666;display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--primary);color:#fff;cursor:pointer}
    button.secondary{background:#fff;color:#111}
    .status{margin-top:8px;white-space:pre-wrap}
    .ok{color:#16a34a}.err{color:#ef4444}.warn{color:#f59e0b}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
    .tab.active{background:#eef6ff;border-color:#c9defc}
    .hidden{display:none}
    .table-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#fff}
    #sum,#sumMerged{margin-top:6px;font-weight:600}
    #currentId{margin-top:10px;font-size:14px;color:#333}
    #currentId code{background:#f0f4ff;padding:2px 6px;border-radius:6px;border:1px solid #c9d4ff}
    .mini{font-size:12px;color:#666}
    .quick-ids{margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .qid{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#f9fafb;color:#111;cursor:pointer}
    .qid:hover{background:#f3f4f6}
    .qid.active{background:#eef6ff;border-color:#c9defc}

    /* Clean Merge UI */
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .toolbar .spacer{flex:1}
    .layout-merge{display:grid;grid-template-columns:260px 1fr 300px;gap:12px}
    .group-list{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff;max-height:560px;overflow:auto}
    .group-item{padding:8px 10px;border:1px solid var(--border);border-radius:10px;margin-bottom:8px;display:flex;justify-content:space-between;gap:10px;align-items:center;cursor:pointer;background:#fff}
    .group-item:hover{background:var(--hover)}
    .group-item.active{border-color:#c9defc;background:#eef6ff}
    .group-name{font-weight:600}
    .group-count{font-size:12px;color:#555;background:#f3f4f6;border:1px solid var(--border);padding:2px 6px;border-radius:999px}
    .group-editor{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;min-height:200px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{background:var(--chip);border:1px solid var(--chip-border);padding:6px 8px;border-radius:999px;display:inline-flex;gap:6px;align-items:center}
    .chip .x{cursor:pointer;border:none;background:transparent;color:#666}
    .add-inline{display:flex;gap:6px;align-items:center;margin-top:8px}
    .side{border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px;max-height:560px;overflow:auto}
    .side-item{display:flex;justify-content:space-between;gap:8px;align-items:center;border:1px solid var(--border);border-radius:10px;padding:6px 8px;margin-bottom:6px;background:#fff}
    .side-item .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:180px}
    .hint{font-size:12px;color:#555;margin-top:6px}
    .pill{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New",monospace; font-size:12px;border:1px solid var(--border);padding:2px 6px;border-radius:6px;background:#f9fafb}
    .ta-paste{min-height:120px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Wave 合併榜單（Clean 維護介面＋TopN 合併）</h1>
  <div class="tabs">
    <div class="tab active" data-pane="pane-query">查榜</div>
    <div class="tab" data-pane="pane-merge">合併維護</div>
  </div>

  <!-- 查榜 -->
  <div id="pane-query" class="card">
    <div class="row two">
      <div>
        <label>範圍 (Scope)</label>
        <select id="scope">
          <option value="user" selected>單一主播</option>
          <option value="global">全平台榜單</option>
        </select>
      </div>
      <div>
        <label>使用者連結或 ID</label>
        <input id="userid" type="text" placeholder="貼主播分享連結或直接輸入 ID（全平台可留空）">
        <div class="quick-ids" id="quickIds">
          <span class="mini">常用：</span>
          <button type="button" class="qid" data-name="稀音" data-id="5bd69b10-a6b2-4241-b175-0782596fd706">稀音</button>
          <button type="button" class="qid" data-name="奶" data-id="5b0f9575-cbf6-4ec5-aab9-c61eecf61eab">奶</button>
          <button type="button" class="qid" data-name="米" data-id="767f272b-ac4c-49c8-9eb8-1ceda7836b2e">米</button>
        </div>
      </div>
    </div>

    <div class="row four" style="margin-top:12px;">
      <div>
        <label>查詢類型</label>
        <select id="select">
          <option value="day0">今日（日榜）</option>
          <option value="day1" selected>昨日（日榜）</option>
          <option value="month0">本月（月榜）</option>
          <option value="month1">上月（月榜）</option>
          <option value="all">總榜 / 珍愛榜</option>
        </select>
      </div>
      <div style="display:none;">
        <label>模式</label>
        <select id="mode">
          <option value="proxy" selected>代理</option>
        </select>
      </div>
      <div style="display:none;">
        <label>附帶憑證（Cookies）</label>
        <select id="cred">
          <option value="omit" selected>omit</option>
        </select>
      </div>
      <div style="display:none;">
        <label>代理基底</label>
        <input id="proxyBase" type="text" value="https://wave-proxy.arbez-9241.workers.dev/">
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div>
        <label class="mini">
          <input type="checkbox" id="limitMergeChk" style="vertical-align:middle; margin-right:6px;" checked> 僅針對前 N 名做合併
        </label>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
          <label class="mini" for="limitMergeN" style="margin:0;">N：</label>
          <input id="limitMergeN" type="number" min="1" value="50" style="width:120px;">
        </div>
        <div class="mini" style="margin-top:6px;">說明：原榜單也只顯示前 N；合併只使用前 N 名做加總，合併後筆數可能少於 N。</div>
      </div>
    </div>

    <div id="currentId"></div>

    <div class="btns" style="margin-top:8px;">
      <button id="run">開始查詢</button>
      <button id="clear" class="secondary">清空</button>
      <button id="exportRaw" class="secondary">匯出（原榜單）Excel</button>
      <button id="exportMerged" class="secondary">匯出（合併榜單）Excel</button>
    </div>
    <div class="status" id="status"></div>
    <div id="sum"></div>
    <div id="sumMerged"></div>
  </div>

  <!-- 原榜單 -->
  <div class="card" id="cardRaw" style="display:none;">
    <div class="table-header">
      <h3>原榜單</h3>
      <span id="badgeRaw" class="badge" style="display:none;"></span>
    </div>
    <table id="tableRaw" class="display" style="width:100%">
      <thead><tr><th>名次</th><th>暱稱</th><th>分數</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 合併後榜單 -->
  <div class="card" id="cardMerged" style="display:none;">
    <div class="table-header">
      <h3>合併後榜單</h3>
      <span id="badgeMerged" class="badge" style="display:none;"></span>
    </div>
    <table id="tableMerged" class="display" style="width:100%">
      <thead><tr><th>名次</th><th>合併暱稱</th><th>分數（合計）</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="mini">提示：合併規則來自「合併維護」頁籤；未對應者沿用原暱稱。</div>
  </div>

  <!-- 合併維護（Clean 版） -->
  <div id="pane-merge" class="card hidden">
    <div class="toolbar">
      <input id="searchInput" placeholder="搜尋（支援片段）" style="width:260px">
      <select id="filterSel" style="width:180px">
        <option value="all" selected>顯示：全部群組</option>
        <option value="unused">只看未分組</option>
        <option value="topn">只看 TopN 出現</option>
        <option value="weird">只看含特殊字元</option>
      </select>
      <button id="bulkBtn" class="secondary">批量貼上</button>
      <div class="spacer"></div>
      <button id="saveMap2">儲存設定</button>
      <button id="applyMap2" class="secondary">套用到合併榜</button>
      <button id="exportCsv2" class="secondary">匯出 CSV</button>
      <button id="exportJson2" class="secondary">匯出 JSON</button>
    </div>

    <div id="bulkArea" class="hidden" style="margin-bottom:10px;">
      <textarea id="bulkTextarea" class="ta-paste" placeholder="每行一筆：暱稱,合併後暱稱（可貼多行）"></textarea>
      <div class="btns" style="margin-top:8px;">
        <button id="bulkApply">套用貼上內容</button>
        <button id="bulkCancel" class="secondary">取消</button>
      </div>
      <div class="hint">格式範例：<span class="kbd">稀音的小mx,MX</span>；遇到空白或格式錯誤會忽略。</div>
    </div>

    <div class="layout-merge">
      <!-- 左：群組清單 -->
      <div class="group-list" id="groupList"></div>

      <!-- 中：群組編輯器 -->
      <div class="group-editor">
        <div style="display:flex;gap:8px;align-items:center;">
          <div style="font-weight:700;">合併後暱稱：</div>
          <input id="editGroupName" placeholder="選一個群組或新增" style="max-width:320px">
          <button id="renameGroupBtn" class="secondary">重新命名</button>
          <button id="newGroupBtn" class="secondary">新增群組</button>
          <div class="spacer"></div>
          <button id="deleteGroupBtn" class="secondary" style="border-color:#fca5a5;color:#b91c1c">刪除群組</button>
        </div>
        <div class="chips" id="memberChips"></div>
        <div class="add-inline">
          <input id="newMemberInput" placeholder="新增原暱稱加入此群組">
          <button id="addMemberBtn" class="secondary">加入</button>
        </div>
        <div class="hint">小技巧：點右側未分組清單項目的「＋」即可快速加入目前群組；按 <span class="kbd">Ctrl+S</span> 儲存、<span class="kbd">Ctrl+Enter</span> 套用。</div>
      </div>

      <!-- 右：未分組（由近一次查榜推得） -->
      <div class="side">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <div style="font-weight:700;">未分組（依最近查榜）</div>
          <label class="mini"><input type="checkbox" id="sideTopN" checked> 只顯示 TopN</label>
        </div>
        <div id="unassignedList"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ---------- Util ----------
const LS_KEY = "WAVE_NAME_MERGE_MAP_V1";
const HISTORY_KEY = "WAVE_NAME_MERGE_HISTORY_V1";

function norm(s){
  if(s==null) return "";
  s = String(s);
  s = s.replace(/[\u0000-\u0008\u000B-\u000C\u000E-\u001F\u007F]/g,""); // control chars
  s = s.replace(/\u3000/g," "); // fullwidth space
  return s.trim();
}
function hasWeirdChar(s){
  // rough check: invisible or non-spacing marks, zero-width, etc.
  return /[\u200B-\u200D\uFEFF]/.test(s);
}
function setStatus(type,msg){ document.getElementById("status").innerHTML = `<span class="${type}">${msg}</span>`; }
function setBadge(id, text){ const el = document.getElementById(id); if(text){ el.textContent=text; el.style.display='inline-block'; } else { el.style.display='none'; el.textContent=''; } }
function sanitizeFilePart(s){ return (s||"").replace(/[\/:*?"<>|]/g, "").replace(/\s+/g, "_").slice(0,40); }

function excelTitle(suffix=""){
  const map = {day0:'今日',day1:'昨日',month0:'本月',month1:'上月',all:'總榜'};
  const sel = document.getElementById('select').value;
  const scope = document.getElementById('scope').value === 'global' ? '全平台' : '單一主播';
  const d = new Date(); const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0');
  let base = `wave_${scope}_${map[sel]||sel}_${yyyy}${mm}${dd}`;
  const tail = sanitizeFilePart(window.CURRENT_ANCHOR_NAME || window.CURRENT_ANCHOR_ID || "");
  if((document.getElementById('scope').value === 'user') && tail) base += `_${tail}`;
  if(suffix) base += `_${suffix}`;
  return base;
}

// ---------- Query & Tables ----------
let table = {};
let lastRawData = []; // {rank,name,score}

function setupTables(){
  table["#tableRaw"] = new DataTable('#tableRaw', { dom:'Blfrtip', buttons:[{extend:'excelHtml5', title:()=>excelTitle('raw')}] });
  table["#tableMerged"] = new DataTable('#tableMerged', { dom:'Blfrtip', buttons:[{extend:'excelHtml5', title:()=>excelTitle('merged')}] });
}
function clearAll(){
  if(table["#tableRaw"]) table["#tableRaw"].clear().draw(false);
  if(table["#tableMerged"]) table["#tableMerged"].clear().draw(false);
  document.getElementById('cardRaw').style.display='none';
  document.getElementById('cardMerged').style.display='none';
  setBadge('badgeRaw',""); setBadge('badgeMerged',"");
  document.getElementById('sum').textContent='';
  document.getElementById('sumMerged').textContent='';
  lastRawData = [];
  setStatus('ok','已清空');
}

function apiBaseUrl(){ return 'https://wave-proxy.arbez-9241.workers.dev'.replace(/\/+$/,''); }
function buildLeaderboardParams(select){
  if(select==='day0') return {type:4,period:4,date_shift:0};
  if(select==='day1') return {type:4,period:4,date_shift:-1};
  if(select==='month0') return {type:4,period:2,date_shift:0};
  if(select==='month1') return {type:4,period:2,date_shift:-1};
  if(select==='all') return {type:4,period:1,date_shift:0};
  return null;
}
async function safeJson(res){ const txt = await res.text(); try{ return JSON.parse(txt);}catch(e){ throw new Error('非 JSON 回應（前 200 字）\\n'+txt.slice(0,200)); } }
function parseUserId(raw){
  if(!raw) return "";
  raw=String(raw).trim();
  try{ const u=new URL(raw); const q=new URLSearchParams(u.search); if(q.get("w_user")) return q.get("w_user"); }catch(e){}
  if(/^[A-Za-z0-9_-]{20,}$/.test(raw) || /^[0-9a-f-]{36}$/i.test(raw)) return raw;
  if(raw.includes("w_user=")){ const t = raw.split("w_user=")[1]; if(t) return t.trim(); }
  return "";
}
function setCurrentId(id, name){
  window.CURRENT_ANCHOR_ID = id || ""; window.CURRENT_ANCHOR_NAME = name || "";
  const box = document.getElementById("currentId");
  if(id){
    const namePart = name ? `（暱稱：<b>${name}</b>）` : "";
    box.innerHTML = `目前查詢 ID：<code>${id}</code> ${namePart}`;
  } else { box.innerHTML = ""; }
}

async function getdata(){
  clearAll();
  setStatus('ok','查詢中...');
  const scope=document.getElementById('scope').value;
  const raw=document.getElementById('userid').value;
  const userid=parseUserId(raw);
  const select=document.getElementById('select').value;
  const cred='omit';
  const base=apiBaseUrl();

  setCurrentId(scope==='user' ? userid : '', null);

  try{
    const params = buildLeaderboardParams(select);
    if(!params){ setStatus('err','請選擇有效的查詢類型'); return; }
    if(scope==='user'){
      if(!userid){ setStatus('err','請輸入使用者連結或 ID'); return; }
      params.user_id = userid;
    }
    const qs=new URLSearchParams(params).toString();
    const url = `${base}/api/v1/leaderboards/event?${qs}`;
    const res = await fetch(url,{credentials:cred});
    if(!res.ok){ throw new Error('排行榜 API HTTP '+res.status); }
    const json = await safeJson(res);
    const data = Array.isArray(json?.data) ? json.data : [];
    lastRawData = data.map(r=>({
      rank: r.rank,
      name: norm(r.userInfo?.displayName || r.user?.displayName || r.userInfo?.nickname || ''),
      score: Number(r.score)||0
    }));
    renderRawTable(lastRawData);
    setBadge('badgeRaw', scope==='user' ? '單一主播' : '全平台');
    setStatus('ok', `筆數：${lastRawData.length}（切到「合併維護」可立即調整）`);

    // 自動套用合併
    if(Object.keys(loadMergeMap()).length>0){
      applyMergeAndRender();
      setBadge('badgeMerged','已套用合併設定');
    }
    // 更新未分組側欄
    refreshUnassigned();
  } catch(e){
    const msg = String(e?.message||e);
    const tips = [
      '・若為 CORS 相關訊息：請確認使用代理端點',
      '・若 API 需登入 Cookie：代理需妥善處理 Access-Control-Allow-Credentials',
      '・Workers/代理需處理 OPTIONS 預檢並回傳 Access-Control-Allow-* 標頭'
    ].join('\\n');
    setStatus('err', msg + '\\n\\n' + tips);
  }
}

function renderRawTable(rows){
  const tb = table['#tableRaw']; tb.clear();
  // respect topN in raw table
  const chk = document.getElementById('limitMergeChk');
  const nEl = document.getElementById('limitMergeN');
  let shown = rows;
  if(chk && chk.checked){ shown = rows.filter(r=> Number(r.rank) <= Number(nEl.value||50)); }
  let total=0;
  shown.forEach(r=>{ const sc=Number(r.score)||0; total+=sc; tb.row.add([r.rank, r.name, sc]); });
  tb.draw(false);
  document.getElementById('cardRaw').style.display='block';
  document.getElementById('sum').textContent = `原榜合計：${total.toLocaleString()}`;
}

function makeMerged(rows, map){
  const bucket = new Map();
  rows.forEach(r=>{
    const original = norm(r.name);
    const merged = map[original] ? norm(map[original]) : original;
    const sc = Number(r.score)||0;
    bucket.set(merged, (bucket.get(merged)||0) + sc);
  });
  const arr = Array.from(bucket.entries()).map(([name,score])=>({name,score})).sort((a,b)=>b.score-a.score);
  arr.forEach((r,i)=>{ r.rank = i+1; });
  return arr;
}
function renderMergedTable(rows){
  const tb = table['#tableMerged']; tb.clear();
  let total=0;
  rows.forEach(r=>{ const sc=Number(r.score)||0; total+=sc; tb.row.add([r.rank, r.name, sc]); });
  tb.draw(false);
  document.getElementById('cardMerged').style.display='block';
  document.getElementById('sumMerged').textContent = `合併後合計：${total.toLocaleString()}`;
}
function applyMergeAndRender(){
  const map = loadMergeMap();
  // strict: source = topN slice only
  const chk = document.getElementById('limitMergeChk');
  const nEl = document.getElementById('limitMergeN');
  let source = lastRawData;
  if(chk && chk.checked){ source = lastRawData.filter(r=> Number(r.rank) <= Number(nEl.value||50)); }
  const merged = makeMerged(source, map);
  renderMergedTable(merged);
}

// ---------- Quick ID ----------
function fillIdQuick(name, id){
  document.getElementById('userid').value = id;
  setCurrentId(id, name);
  document.querySelectorAll('.qid').forEach(btn=>btn.classList.remove('active'));
  const btn = Array.from(document.querySelectorAll('.qid')).find(b=>b.dataset.id===id);
  if(btn) btn.classList.add('active');
  getdata();
}

// ---------- Merge Map (storage + history) ----------
function loadMergeMap(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)||"{}"); }catch(e){ return {}; }
}
function saveMergeMap(map){
  // save snapshot for undo
  try{
    const hist = JSON.parse(localStorage.getItem(HISTORY_KEY)||"[]");
    hist.push({ ts: Date.now(), map: loadMergeMap() });
    localStorage.setItem(HISTORY_KEY, JSON.stringify(hist.slice(-10))); // keep last 10
  }catch(e){}
  localStorage.setItem(LS_KEY, JSON.stringify(map));
  updateMapInfo();
}
function updateMapInfo(){
  const map = loadMergeMap();
  const pairs = Object.entries(map);
  const mergedNames = new Set(Object.values(map).map(norm));
  document.getElementById('mapInfo').textContent = `目前共有 ${pairs.length} 筆對應；合併後暱稱共 ${mergedNames.size} 種。（資料只存在你的瀏覽器）`;
}

// ---------- Clean UI (groups + sidebar) ----------
let currentGroup = null; // current merged name

function buildGroupsFromMap(map){
  // invert: mergedName -> [original...]
  const groups = {};
  Object.entries(map).forEach(([k,v])=>{
    const key = norm(k);
    const tgt = norm(v || k);
    if(!groups[tgt]) groups[tgt] = [];
    groups[tgt].push(key);
  });
  // sort members
  Object.values(groups).forEach(arr => arr.sort((a,b)=> a.localeCompare(b,'zh-Hant')));
  return groups;
}

function refreshGroupList(){
  const list = document.getElementById('groupList');
  list.innerHTML = "";
  const map = loadMergeMap();
  const groups = buildGroupsFromMap(map);
  const filter = document.getElementById('filterSel').value;
  const q = norm(document.getElementById('searchInput').value).toLowerCase();

  // derive topN name set / weird set / unassigned set
  const topNNames = new Set(lastRawData.filter(r=> Number(r.rank) <= Number(document.getElementById('limitMergeN').value||50)).map(r=> norm(r.name)));
  const weird = (s)=> hasWeirdChar(s);

  const allMergedNames = Object.keys(groups).sort((a,b)=> a.localeCompare(b,'zh-Hant'));

  allMergedNames.forEach(mergedName=>{
    // filter logic
    if(q && !mergedName.toLowerCase().includes(q)) return;
    if(filter === 'topn'){
      // show groups where mergedName or any member appeared in topN recently
      const members = groups[mergedName] || [];
      const keep = topNNames.has(mergedName) || members.some(m=> topNNames.has(m));
      if(!keep) return;
    } else if(filter === 'weird'){
      if(!(weird(mergedName) || (groups[mergedName]||[]).some(weird))) return;
    }
    // 'unused' is handled in sidebar (unassigned), so skip here

    const item = document.createElement('div');
    item.className = 'group-item' + (currentGroup===mergedName ? ' active' : '');
    item.innerHTML = `<div class="group-name">${mergedName||'(未命名)'}</div>
                      <div class="group-count">${(groups[mergedName]||[]).length}</div>`;
    item.addEventListener('click', ()=>{ currentGroup = mergedName; refreshEditor(); refreshGroupList(); });
    list.appendChild(item);
  });
}

function refreshEditor(){
  const map = loadMergeMap();
  const groups = buildGroupsFromMap(map);
  const editorName = document.getElementById('editGroupName');
  const chips = document.getElementById('memberChips');
  editorName.value = currentGroup || '';
  chips.innerHTML = '';
  (groups[currentGroup]||[]).forEach(mem=>{
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.innerHTML = `<span>${mem}</span><button class="x" title="移除">×</button>`;
    chip.querySelector('.x').onclick = ()=>{
      // remove member from map
      const m = loadMergeMap();
      delete m[mem];
      saveMergeMap(m);
      refreshEditor(); refreshGroupList(); refreshUnassigned();
    };
    chips.appendChild(chip);
  });
}

function refreshUnassigned(){
  const list = document.getElementById('unassignedList');
  list.innerHTML = '';
  const map = loadMergeMap();
  const assigned = new Set(Object.keys(map).map(norm));
  const onlyTop = document.getElementById('sideTopN').checked;
  const n = Number(document.getElementById('limitMergeN').value||50);
  const source = onlyTop ? lastRawData.filter(r=> Number(r.rank)<=n) : lastRawData;
  // unique by name, excluding assigned
  const seen = new Set();
  source.forEach(r=>{
    const name = norm(r.name);
    if(assigned.has(name) || seen.has(name)) return;
    seen.add(name);
    const row = document.createElement('div');
    row.className = 'side-item';
    row.innerHTML = `<span class="name" title="${name}">${name}</span>
                     <div style="display:flex;gap:6px;align-items:center;">
                       <span class="pill">#${r.rank}</span>
                       <button class="secondary btn-add">＋</button>
                     </div>`;
    row.querySelector('.btn-add').onclick = ()=>{
      if(!currentGroup){ alert('請先在中間選擇或建立一個「合併後暱稱」群組'); return; }
      const m = loadMergeMap();
      m[name] = currentGroup;
      saveMergeMap(m);
      refreshEditor(); refreshGroupList(); refreshUnassigned();
    };
    list.appendChild(row);
  });
}

// actions
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id==='newGroupBtn'){
    const name = norm(document.getElementById('editGroupName').value);
    if(!name){ alert('請輸入群組名稱（合併後暱稱）'); return; }
    currentGroup = name;
    refreshGroupList(); refreshEditor();
  }
  if(e.target && e.target.id==='deleteGroupBtn'){
    if(!currentGroup){ alert('尚未選擇群組'); return; }
    if(!confirm(`刪除群組「${currentGroup}」？（不會刪除原暱稱，只會把它們變成未分組）`)) return;
    const m = loadMergeMap();
    Object.keys(m).forEach(k=>{ if(norm(m[k])===currentGroup) delete m[k]; });
    saveMergeMap(m);
    currentGroup = null;
    refreshGroupList(); refreshEditor(); refreshUnassigned();
  }
  if(e.target && e.target.id==='addMemberBtn'){
    if(!currentGroup){ alert('請先選擇或建立群組'); return; }
    const nm = norm(document.getElementById('newMemberInput').value);
    if(!nm){ return; }
    const m = loadMergeMap();
    m[nm] = currentGroup;
    saveMergeMap(m);
    document.getElementById('newMemberInput').value = '';
    refreshEditor(); refreshGroupList(); refreshUnassigned();
  }
  if(e.target && e.target.id==='saveMap2'){
    setStatus('ok','已儲存合併設定');
  }
  if(e.target && e.target.id==='applyMap2'){
    applyMergeAndRender(); setBadge('badgeMerged','已套用合併設定'); setStatus('ok','已套用');
  }
  if(e.target && e.target.id==='exportCsv2'){
    exportCsvFromMap(loadMergeMap());
  }
  if(e.target && e.target.id==='exportJson2'){
    exportJsonFromMap(loadMergeMap());
  }
  if(e.target && e.target.id==='bulkBtn'){
    document.getElementById('bulkArea').classList.toggle('hidden');
  }
  if(e.target && e.target.id==='bulkCancel'){
    document.getElementById('bulkArea').classList.add('hidden');
  }
  if(e.target && e.target.id==='bulkApply'){
    const txt = document.getElementById('bulkTextarea').value||'';
    const lines = txt.split(/\r?\n/);
    const m = loadMergeMap();
    let added = 0;
    lines.forEach(line=>{
      const parts = line.split(',');
      if(parts.length>=1){
        const k = norm(parts[0]);
        const v = norm(parts[1]||parts[0]);
        if(k){ m[k]= v || k; added++; }
      }
    });
    saveMergeMap(m);
    document.getElementById('bulkArea').classList.add('hidden');
    document.getElementById('bulkTextarea').value = '';
    refreshGroupList(); refreshEditor(); refreshUnassigned();
    setStatus('ok', `已套用批量貼上 ${added} 筆`);
  }
});

// filters & search
document.addEventListener('input', (e)=>{
  if(e.target && (e.target.id==='searchInput' || e.target.id==='filterSel')){
    refreshGroupList();
  }
  if(e.target && e.target.id==='sideTopN'){
    refreshUnassigned();
  }
});

// keyboard shortcuts
document.addEventListener('keydown', (e)=>{
  if(e.ctrlKey && e.key==='s'){ e.preventDefault(); setStatus('ok','已儲存合併設定'); }
  if(e.ctrlKey && e.key==='Enter'){ e.preventDefault(); applyMergeAndRender(); setBadge('badgeMerged','已套用合併設定'); setStatus('ok','已套用'); }
});

// ---------- Tabs & Init ----------
function switchTab(paneId){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('pane-query').classList.add('hidden');
  document.getElementById('pane-merge').classList.add('hidden');
  document.querySelector(`.tab[data-pane="${paneId}"]`).classList.add('active');
  document.getElementById(paneId).classList.remove('hidden');
  if(paneId==='pane-merge'){ refreshGroupList(); refreshEditor(); refreshUnassigned(); }
}

function setup(){
  setupTables();
  // tabs
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click', ()=> switchTab(tab.dataset.pane));
  });
  // quick ids
  document.querySelectorAll('.qid').forEach(btn=>{
    btn.addEventListener('click', ()=> fillIdQuick(btn.dataset.name, btn.dataset.id));
  });
  // query buttons
  document.getElementById('run').onclick=getdata;
  document.getElementById('clear').onclick=()=>{ clearAll(); setCurrentId('', null); };
  document.getElementById('exportRaw').onclick=()=>{ table['#tableRaw'].button('.buttons-excel').trigger(); };
  document.getElementById('exportMerged').onclick=()=>{ table['#tableMerged'].button('.buttons-excel').trigger(); };
  // auto refresh on topN toggle
  document.getElementById('limitMergeChk').addEventListener('change', ()=>{ if(lastRawData.length){ renderRawTable(lastRawData); applyMergeAndRender(); refreshUnassigned(); } });
  document.getElementById('limitMergeN').addEventListener('input', ()=>{ if(lastRawData.length){ renderRawTable(lastRawData); applyMergeAndRender(); refreshUnassigned(); } });

  // initial
  updateMapInfo();
}

window.onload = setup;

// === 重新命名目前群組（合併後暱稱） ===
function renameCurrentGroup(newName){
  newName = norm(newName);
  if(!currentGroup){ alert('請先從左側選擇一個群組'); return; }
  if(!newName){ alert('新名稱不能是空白'); return; }
  if(newName === currentGroup){ setStatus('warn','新舊名稱相同，未變更'); return; }

  const m = loadMergeMap();
  let touched = 0;
  Object.keys(m).forEach(k=>{
    if(norm(m[k]) === currentGroup){
      m[k] = newName;
      touched++;
    }
  });

  saveMergeMap(m);
  currentGroup = newName;
  const input = document.getElementById('editGroupName'); if(input) input.value = newName;
  refreshEditor(); refreshGroupList(); refreshUnassigned();
  setStatus('ok', `已將群組重新命名為「${newName}」（影響 ${touched} 筆）`);
}

// Button handler
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id === 'renameGroupBtn'){
    const val = document.getElementById('editGroupName')?.value;
    renameCurrentGroup(val);
  }
});

// Enter key to rename
document.getElementById('editGroupName')?.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    e.preventDefault();
    renameCurrentGroup(e.target.value);
  }
});

</script>
</body>
</html>
